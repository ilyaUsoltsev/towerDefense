# Логика Tower Defense игры

## Обзор

Это игра в жанре tower defense с системой волн, где враги появляются и движутся по пути от старта к финишу, а игрок размещает и улучшает пушки, чтобы уничтожить их до того, как они достигнут цели. Игра включает систему экономики (деньги/здоровье игрока), несколько типов пушек с возможностью улучшения, волны врагов различных типов и архитектуру на основе паттерна Стратегия для снарядов.

## Основные компоненты

### Игровой движок ([managers/gameEngine.ts](managers/gameEngine.ts))

Главный класс, который связывает все системы воедино. Он управляет игровым циклом и координирует отрисовку:

1. **Инициализация**: настраивает все менеджеры (Map, Path, Enemy, Cannon, Projectile) и создаёт объект Player
2. **Игровой цикл**: работает с частотой 60 FPS с использованием `requestAnimationFrame` с пропуском кадров
3. **Порядок отрисовки**:
   - Слои карты (игровое поле, стены, старт, финиш)
   - Обновление врагов (спавн, движение, удаление)
   - Обновление пушек (наведение, стрельба)
   - Обновление снарядов (движение, столкновения)
   - Отрисовка пушек с индикаторами радиуса
   - Отрисовка снарядов
   - Отрисовка врагов с полосками здоровья

### Игрок ([entities/player.ts](entities/player.ts))

Управляет состоянием игрока:

- **Здоровье**: начинается с 10 HP (настраивается через `GameConfig.hp`)
- **Деньги**: начинается с 80 монет (настраивается через `GameConfig.initialMoney`)
- **Методы**:
  - `takeDamage()` — теряет 1 HP при достижении врагом конца пути
  - `isDead()` — проверка окончания игры
  - `addMoney(amount)` / `subtractMoney(amount)` — для покупки пушек и вознаграждений за убийство врагов
  - `haveEnoughMoney(amount)` — валидация покупок
  - `getMoney()` / `getHp()` — запросы состояния

### Менеджер карты ([managers/mapManager.ts](managers/mapManager.ts))

Отвечает за игровую карту и взаимодействие с пользователем:

- **Данные карты**: загружает макет карты из JSON с разными слоями (Game, Walls, Start, Finish)
- **Сетка коллизий**: создаёт 2D-массив, помечающий проходимые (0) и заблокированные (1) тайлы
- **Размещение пушек**: отслеживает клики по canvas и пытается разместить пушки на допустимых тайлах
- **Выбор типа пушки**: отслеживает `placingCannonType` для размещения разных типов пушек
- **Валидация**: запрещает размещение пушек на стартовом тайле, уже занятых тайлах или при недостатке денег
- **Предпросмотр курсора**: отображает тайл под курсором при размещении пушки

### Менеджер пути ([managers/pathManager.ts](managers/pathManager.ts))

Управляет поиском пути с использованием алгоритма A* (через EasyStar.js):

- **Динамический поиск пути**: вычисляет оптимальный путь от стартового тайла до финишного
- **Проверка пути**: при размещении пушки проверяет, что путь всё ещё существует
- **Предотвращение блокировки пути**: отклоняет размещение пушек, которые полностью блокируют движение врагов
- **Событийные обновления**: отправляет событие `pathManager:pathUpdated`, чтобы все враги пересчитали маршрут с текущей позиции

### Система врагов

#### Класс врага ([entities/enemy.ts](entities/enemy.ts))

Поведение отдельного врага:

- **Типы врагов**: normal (розовый, скорость 1), fast (голубой, скорость 1.5), immune (зелёный, скорость 1, больший радиус 12px), normalBoss (красный, скорость 1, больший размер)
- **Здоровье**: настраивается для каждой волны (от 20 до 500 HP для боссов)
- **Движение**: следует по рассчитанному пути с переменной скоростью (1-1.5 пикселя/кадр в зависимости от типа)
- **Поиск пути**: использует путь из PathManager и движется тайл за тайлом
- **Динамическая перенастройка маршрута**: слушает события `pathManager:pathUpdated` и пересчитывает путь с текущей позиции
- **Система урона**: получает урон от снарядов, уничтожается при 0 здоровья
- **Вознаграждение**: даёт игроку деньги при уничтожении (5-50 монет в зависимости от типа)
- **Отрисовка**: цветной круг с полоской здоровья, показывающей текущее/максимальное здоровье

#### Менеджер врагов ([managers/enemyManager.ts](managers/enemyManager.ts))

Управляет жизненным циклом врагов и системой волн:

- **Система волн**: загружает конфигурацию волн из `waves-config.ts` с настройками типа врага, количества, интервала спавна, здоровья и вознаграждения
- **Спавн**: автоматически создаёт врагов на основе текущей волны с переменными интервалами (300-900 мс)
- **Задержка между волнами**: 10 секунд (настраивается через `GameConfig.waveDelay`)
- **Очистка**: удаляет врагов, которые уничтожены или достигли конца
- **Обработка уничтожения**: даёт игроку деньги и удаляет врага при смерти
- **Обработка достижения конца**: наносит урон игроку (1 HP) и удаляет врага
- **Проверка окончания игры**: отслеживает завершение всех волн и отсутствие активных врагов
- **События**: отправляет `redux:waveStarted` при начале новой волны

### Система пушек

#### Класс пушки ([entities/cannon.ts](entities/cannon.ts))

Поведение отдельной пушки с системой улучшений:

- **Типы пушек** (из `cannons-config.ts`):
  - **dumb** (стоимость 2) — стена/препятствие без боевых параметров
  - **basic** (стоимость 5) — стандартная пушка, 60px радиус, 10 урона, 1500ms скорострельность
  - **rocket** (стоимость 15) — зонный урон, 70px радиус, 50px радиус взрыва, 800ms скорострельность
  - **sniper** (стоимость 50) — дальнобойная, 100px радиус, 50 урона, 4000ms скорострельность
  - **freeze** (стоимость 50) — 80px радиус, 10 урона, 1500ms скорострельность
- **Система улучшений**: максимальный уровень 5 (настраивается через `GameConfig.maxCannonLevel`)
  - `upgrade()` увеличивает: урон ×1.1, радиус ×1.2, скорострельность ×0.9 (быстрее), скорость снаряда ×1.1, радиус взрыва ×1.2
  - Стоимость улучшения растёт с каждым уровнем: `cost += upgradeCost * level`
- **Наведение**: автоматически выбирает первого врага в радиусе
- **Стрельба**: при выстреле создаёт снаряд с определённой стратегией через ProjectileManager
- **Отрисовка**: квадрат на тайле с полупрозрачным кругом радиуса, цвет зависит от типа

#### Менеджер пушек ([managers/cannonManager.ts](managers/cannonManager.ts))

Управляет всеми пушками:

- **Размещение**: слушает события `mapManager:cannonPlaced` и создаёт новые пушки с проверкой денег игрока
- **Улучшение**: `upgradeCannon(id)` улучшает пушку с валидацией стоимости и максимального уровня
- **Продажа**: `sellCannon(id)` возвращает 70% от стоимости покупки и освобождает тайл
- **Обновление**: обновляет все пушки каждый кадр с учётом текущих позиций врагов
- **Координация**: передаёт живых врагов каждой пушке для наведения
- **События**: слушает `redux:selectedCannon` для обработки выбора пушки

### Система снарядов

Использует **паттерн Стратегия** для расширяемой архитектуры с различными типами движения и столкновений.

#### Класс снаряда ([entities/projectile/projectile.ts](entities/projectile/projectile.ts))

Поведение отдельного снаряда с композицией стратегий:

- **Скорость**: зависит от пушки (улучшается при улучшении пушки)
- **Урон**: зависит от пушки (10-50 базового урона)
- **Движение**: определяется `MoveStrategy`
- **Столкновение**: определяется `CollisionStrategy`
- **Отрисовка**: оранжевый круг (настраивается через `GameConfig.projectile`)

#### Стратегии движения (MoveStrategy)

Абстрактный класс: [entities/projectile/MoveStrategy.ts](entities/projectile/MoveStrategy.ts)

Реализации:

- **StraightMove** ([StraightMove.ts](entities/projectile/StraightMove.ts)) — летит по прямой линии от начальной точки до достижения радиуса пушки
- **AtTargetMove** ([AtTargetMove.ts](entities/projectile/AtTargetMove.ts)) — летит прямо к цели, взрывается при достижении (для ракет)
- **NoMove** ([NoMove.ts](entities/projectile/NoMove.ts)) — неподвижный снаряд (не используется)

#### Стратегии столкновения (CollisionStrategy)

Абстрактный класс: [entities/projectile/CollisionStrategy.ts](entities/projectile/CollisionStrategy.ts)

Реализации:

- **SingleHitCollision** ([SingleHitCollision.ts](entities/projectile/SingleHitCollision.ts)) — уничтожается при первом контакте с врагом, наносит урон одной цели
- **ExplosionCollision** ([ExplosionCollision.ts](entities/projectile/ExplosionCollision.ts)) — зонный урон в радиусе взрыва, наносит урон всем врагам в области после взрыва снаряда
- **NoCollisionStrategy** ([NoCollisionStrategy.ts](entities/projectile/NoCollisionStrategy.ts)) — без обнаружения столкновений (для dumb пушек)

#### Конфигурация снарядов ([managers/constants/projectile-config.ts](managers/constants/projectile-config.ts))

Сопоставление типов пушек со стратегиями:

```typescript
projectileConfig = {
  dumb: { moveStrategy: NoMove, collisionStrategy: NoCollisionStrategy },
  basic: { moveStrategy: StraightMove, collisionStrategy: SingleHitCollision },
  fast: { moveStrategy: StraightMove, collisionStrategy: SingleHitCollision },
  rocket: { moveStrategy: AtTargetMove, collisionStrategy: ExplosionCollision },
  sniper: { moveStrategy: StraightMove, collisionStrategy: SingleHitCollision },
  freeze: { moveStrategy: AtTargetMove, collisionStrategy: ExplosionCollision }
}
```

#### Менеджер снарядов ([managers/projectileManager.ts](managers/projectileManager.ts))

Управляет жизненным циклом всех снарядов:

- **Создание**: принимает запросы от пушек, создаёт снаряды с соответствующими стратегиями движения и столкновения на основе типа пушки
- **Обновление**: обновляет позиции всех снарядов (вызывает `moveStrategy.move()`) и проверяет столкновения (вызывает `collisionStrategy.checkCollision()`)
- **Очистка**: удаляет уничтоженные снаряды из списка
- **Отрисовка**: отрисовывает все активные снаряды

## Система событий ([utils/eventBus.ts](utils/eventBus.ts))

Централизованная событийно-ориентированная коммуникация между компонентами (паттерн Singleton):

**Методы**:

- `on(event, handler)` — подписка на событие, возвращает функцию отписки
- `once(event, handler)` — одноразовый слушатель
- `emit(event, payload)` — рассылка события

**События игровой логики**:

- `pathManager:pathUpdated` — путь изменён, враги пересчитывают маршруты
- `mapManager:cannonPlaced` — пушка успешно размещена
- `mapManager:tryAddCannon` — клик пользователя для размещения пушки

**События Redux (интеграция с UI)**:

- `redux:waveStarted` — начало новой волны
- `redux:selectedCannon` — пушка выбрана для улучшения/продажи
- `redux:setMoney` — обновление денег игрока
- `redux:setPlayerHp` — обновление здоровья игрока

## Игровой процесс

### Последовательность инициализации

1. GameEngine создаёт Player с начальными деньгами (80) и здоровьем (10)
2. MapManager загружает данные карты из JSON
3. PathManager рассчитывает начальный путь от старта к финишу с использованием A*
4. EnemyManager загружает конфигурацию волн и подготавливается к спавну
5. Запускается автоспавн первой волны
6. Враги начинают движение по пути

### Игровой цикл (каждый кадр @ 60 FPS)

1. Очистка canvas
2. Отрисовка слоёв карты (игровое поле, стены, старт, финиш)
3. **Обновление врагов** (EnemyManager):
   - Проверка задержки между волнами
   - Автоспавн врагов текущей волны с интервалами из конфигурации
   - Движение всех врагов по их путям с учётом скорости типа
   - Обработка достижения конца (урон игроку -1 HP)
   - Обработка уничтожения (награда игроку деньгами)
   - Проверка окончания игры (все волны завершены или здоровье игрока = 0)
4. **Обновление пушек** (CannonManager):
   - Проверка врагов в радиусе каждой пушки
   - Выстрел (создание снарядов с соответствующими стратегиями), если кулдаун завершён
5. **Обновление снарядов** (ProjectileManager):
   - Движение всех снарядов (вызов `moveStrategy.move()`)
   - Проверка столкновений (вызов `collisionStrategy.checkCollision()`)
   - Нанесение урона при попадании (одиночный или зонный в зависимости от стратегии)
   - Удаление уничтоженных снарядов
6. Отрисовка пушек (с кругами радиуса и цветом типа)
7. Отрисовка снарядов
8. Отрисовка врагов (с полосками здоровья и цветами типов)

### Процесс размещения пушки

1. Игрок выбирает тип пушки (MapManager отслеживает `placingCannonType`)
2. Игрок кликает по canvas
3. MapManager переводит клик в координаты тайла
4. Проверяется валидность тайла (не стартовый, не занятый, достаточно денег у игрока)
5. MapManager отправляет событие `tryAddCannon` с типом пушки
6. PathManager проверяет размещение:
   - Временно добавляет пушку в карту коллизий
   - Пытается найти путь с новым препятствием с использованием A*
   - Если путь существует — подтверждает размещение
   - Если пути нет — показывает alert и отклоняет
7. При успехе отправляется событие `cannonPlaced` с позицией и типом
8. CannonManager:
   - Вычитает стоимость пушки из денег игрока
   - Создаёт новую пушку указанного типа в позиции
   - Обновляет деньги игрока через событие `redux:setMoney`
9. PathManager отправляет событие `pathUpdated`
10. Все враги пересчитывают маршруты с текущих позиций до финиша

### Боевая механика

1. Каждый кадр пушки проверяют всех живых врагов
2. Если враг в радиусе И кулдаун завершён:
   - Пушка создаёт снаряд через ProjectileManager с типом пушки
   - ProjectileManager выбирает соответствующие стратегии движения и столкновения из конфигурации
   - Снаряд создаётся с композицией стратегий и нацелен на текущую позицию врага
   - Запускается таймер кулдауна пушки
3. ProjectileManager обновляет все активные снаряды:
   - Вызывает `moveStrategy.move()` для перемещения снаряда
   - Вызывает `collisionStrategy.checkCollision()` для проверки попаданий
4. При столкновении с врагом (зависит от стратегии):
   - **SingleHitCollision**: наносит урон одному врагу, снаряд уничтожается
   - **ExplosionCollision**: когда снаряд достигает цели, наносит зонный урон всем врагам в радиусе взрыва
   - **NoCollisionStrategy**: не проверяет столкновения (для dumb пушек)
5. Если здоровье врага достигает 0:
   - Враг помечается как уничтоженный
   - EnemyManager награждает игрока деньгами (из конфигурации волны)
6. Уничтоженные враги удаляются на следующем кадре EnemyManager'ом
7. Уничтоженные снаряды удаляются ProjectileManager'ом

### Процесс улучшения пушки

1. Игрок кликает по пушке на карте
2. MapManager отправляет событие `redux:selectedCannon` с данными пушки
3. UI отображает информацию о пушке (уровень, урон, радиус, стоимость улучшения)
4. Игрок нажимает кнопку "Улучшить"
5. CannonManager.upgradeCannon(id):
   - Проверяет, что пушка не достигла максимального уровня (5)
   - Проверяет, что у игрока достаточно денег
   - Вычитает стоимость улучшения
   - Вызывает `cannon.upgrade()` — увеличивает характеристики (урон, радиус, скорострельность и т.д.)
   - Обновляет деньги игрока через событие `redux:setMoney`

### Процесс продажи пушки

1. Игрок кликает по пушке на карте
2. UI отображает кнопку "Продать"
3. CannonManager.sellCannon(id):
   - Вычисляет возврат денег: 70% от полной стоимости (начальная + все улучшения)
   - Добавляет деньги игроку
   - Освобождает тайл в MapManager (устанавливает collision = 0)
   - Удаляет пушку из массива
   - Пересчитывает путь через PathManager
   - Обновляет деньги игрока через событие `redux:setMoney`

### Система волн

1. EnemyManager загружает `wavesConfig` при инициализации
2. Каждая волна определяет:
   - Тип врага (normal, fast, immune, normalBoss)
   - Количество врагов
   - Интервал спавна (мс)
   - Здоровье врага (переопределяет базовое из `enemies-config.ts`)
   - Вознаграждение за убийство
3. Процесс волны:
   - Задержка 10 секунд перед началом следующей волны
   - Отправка события `redux:waveStarted` в UI
   - Спавн врагов с указанным интервалом до достижения количества
   - Переход к следующей волне после уничтожения/достижения конца всех врагов
4. Окончание игры:
   - **Победа**: все волны завершены и все враги уничтожены
   - **Поражение**: здоровье игрока достигло 0

## Конфигурация

Все параметры игры вынесены в отдельные файлы конфигурации в `../constants/`:

### Игровые параметры ([constants/game-config.ts](../constants/game-config.ts))

```typescript
{
  waveDelay: 10000,           // Задержка между волнами (мс)
  hp: 10,                     // Начальное здоровье игрока
  initialMoney: 80,           // Начальные деньги игрока
  tileSize: 32,               // Размер тайла (пикселей)
  maxCannonLevel: 5,          // Максимальный уровень улучшения пушки
  healthBar: {
    width: 24,                // Ширина полоски здоровья
    height: 3,                // Высота полоски здоровья
    offset: 18                // Смещение над врагом
  },
  projectile: {
    radius: 3,                // Радиус снаряда
    color: 'orange'           // Цвет снаряда
  }
}
```

### Типы пушек ([constants/cannons-config.ts](../constants/cannons-config.ts))

```typescript
{
  dumb: { cost: 2, range: 0, damage: 0, fireRate: 0, ... },
  basic: { cost: 5, range: 60, damage: 10, fireRate: 1500, projectileSpeed: 3, ... },
  fast:  {cost: 15...},
  rocket: { cost: 20, range: 70, damage: 15, fireRate: 800, explosionRadius: 50, ... },
  sniper: { cost: 50, range: 100, damage: 50, fireRate: 4000, projectileSpeed: 15, ... },
  freeze: { cost: 50, range: 80, damage: 10, fireRate: 1500, projectileSpeed: 3, ... }
}
```

### Типы врагов ([constants/enemies-config.ts](../constants/enemies-config.ts))

```typescript
{
  normal: { speed: 1, color: 'pink', radius: 10 },
  fast: { speed: 1.5, color: 'lightblue', radius: 10 },
  immune: { speed: 1, color: 'lightgreen', radius: 12, immune: true },
  normalBoss: { speed: 1, color: 'red', radius: 10 }
}
```

### Волны ([constants/waves-config.ts](../constants/waves-config.ts))

Массив из 4+ волн с возрастающей сложностью:

```typescript
[
  { enemyType: 'normal', count: 5, spawnInterval: 500, hp: 20, reward: 5 },
  { enemyType: 'fast', count: 5, spawnInterval: 300, hp: 30, reward: 7 },
  { enemyType: 'immune', count: 5, spawnInterval: 500, hp: 40, reward: 6 },
  { enemyType: 'normalBoss', count: 3, spawnInterval: 900, hp: 500, reward: 50 },
  ...
]
```

## Ключевые паттерны

- **Manager Pattern**: отдельные менеджеры для Map, Path, Enemy, Cannon, Projectile — чёткое разделение ответственности
- **Strategy Pattern**: снаряды используют композицию стратегий движения (MoveStrategy) и столкновения (CollisionStrategy) для гибкого поведения
- **Event-Driven Architecture**: слабосвязанное взаимодействие через EventBus (Singleton)
- **Entity-Component**: каждый враг, пушка и снаряд — независимая сущность с собственным состоянием
- **Centralized Management**: снаряды управляются централизованно через ProjectileManager, а не каждой пушкой отдельно
- **Reactive Pathfinding**: путь пересчитывается при изменении карты (A* через EasyStar.js), враги автоматически обновляют маршруты
- **Validation Before State Change**: путь должен существовать до подтверждения размещения пушки, деньги проверяются перед покупкой
- **Configuration-Driven**: все параметры игры, типы сущностей и волны вынесены в отдельные файлы конфигурации для лёгкой настройки
- **Progressive Difficulty**: система волн с возрастающей сложностью (здоровье врагов, скорость спавна, типы)
- **Economy System**: игрок управляет двумя ресурсами (деньги и здоровье), требующими стратегического баланса
