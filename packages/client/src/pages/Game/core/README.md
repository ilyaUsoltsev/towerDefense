# Логика Tower Defense игры

## Обзор

Это классическая игра в жанре tower defense, где враги появляются и движутся по пути от старта к финишу, а игрок размещает пушки, чтобы уничтожить их до того, как они достигнут цели.

## Основные компоненты

### Игровой движок ([gameEngine.ts](gameEngine.ts))

Главный класс, который связывает все системы воедино. Он управляет игровым циклом и координирует отрисовку:

1. **Инициализация**: настраивает все менеджеры (Map, Path, Enemy, Cannon, Projectile)
2. **Игровой цикл**: работает с частотой 60 FPS с использованием `requestAnimationFrame`
3. **Порядок отрисовки**:
   - Слои карты (игровое поле, стены, старт, финиш)
   - Визуализация пути
   - Враги с полосками здоровья
   - Пушки с индикаторами радиуса
   - Снаряды

### Менеджер карты ([mapManager.ts](mapManager.ts))

Отвечает за игровую карту и взаимодействие с пользователем:

- **Данные карты**: загружает макет карты из JSON с разными слоями (Game, Walls, Start, Finish)
- **Сетка коллизий**: создаёт 2D-массив, помечающий проходимые (0) и заблокированные (1) тайлы
- **Размещение пушек**: отслеживает клики по canvas и пытается разместить пушки на допустимых тайлах
- **Валидация**: запрещает размещение пушек на стартовом тайле или уже занятых тайлах

### Менеджер пути ([pathManager.ts](pathManager.ts))

Управляет поиском пути с использованием алгоритма A* (через EasyStar.js):

- **Динамический поиск пути**: вычисляет оптимальный путь от стартового тайла до финишного
- **Проверка пути**: при размещении пушки проверяет, что путь всё ещё существует
- **Предотвращение блокировки пути**: отклоняет размещение пушек, которые полностью блокируют движение врагов
- **Событийные обновления**: уведомляет всех врагов об изменении пути, чтобы они могли пересчитать маршрут

### Система врагов

#### Класс врага ([enemy.ts](enemy.ts))

Поведение отдельного врага:

- **Здоровье**: начинается со 100 HP (настраивается), отображается цветная полоска здоровья
- **Движение**: следует по рассчитанному пути со скоростью 1 пиксель/кадр
- **Поиск пути**: использует путь из PathManager и движется тайл за тайлом
- **Динамическая перенастройка маршрута**: слушает события `pathManager:pathUpdated` и пересчитывает путь с текущей позиции
- **Система урона**: получает урон от снарядов, уничтожается при 0 здоровье
- **Отрисовка**: красный круг с полоской здоровья, показывающей текущее/максимальное здоровье

#### Менеджер врагов ([enemyManager.ts](enemyManager.ts))

Управляет жизненным циклом врагов:

- **Спавн**: автоматически создаёт врагов каждые 2000 мс (настраивается)
- **Очистка**: удаляет врагов, которые уничтожены или достигли конца
- **Управление волнами**: может генерировать группы врагов
- **Настройка здоровья**: поддерживает кастомные значения здоровья для врагов

### Система пушек

#### Класс пушки ([cannon.ts](cannon.ts))

Поведение отдельной пушки:

- **Радиус действия**: 64 пикселя (2 тайла) по умолчанию
- **Скорострельность**: 1 выстрел в секунду (кулдаун 1000 мс)
- **Наведение**: автоматически выбирает первого врага в радиусе, который ещё не достиг конца
- **Стрельба**: при выстреле создаёт снаряд через ProjectileManager
- **Отрисовка**: чёрный квадрат на тайле с полупрозрачным кругом радиуса

#### Менеджер пушек ([cannonManager.ts](cannonManager.ts))

Управляет всеми пушками:

- **Размещение**: слушает события `mapManager:cannonPlaced` и создаёт новые пушки
- **Обновление**: обновляет все пушки каждый кадр с учётом текущих позиций врагов
- **Координация**: передаёт живых врагов каждой пушке для наведения

### Система снарядов

#### Класс снаряда ([projectile.ts](projectile.ts))

Поведение отдельного снаряда:

- **Скорость**: 5 пикселей/кадр по умолчанию
- **Урон**: 2 единицы по умолчанию
- **Движение**: летит по прямой линии к целевой точке
- **Столкновение**: проверяет пересечение с радиусом врага (10 пикселей)
- **Уничтожение**: исчезает при попадании во врага или при достижении целевой позиции
- **Отрисовка**: оранжевый круг

#### Менеджер снарядов ([projectileManager.ts](projectileManager.ts))

Управляет жизненным циклом всех снарядов:

- **Создание**: принимает запросы от пушек на создание новых снарядов
- **Обновление**: обновляет позиции всех снарядов и проверяет столкновения с врагами
- **Очистка**: удаляет уничтоженные снаряды из списка
- **Отрисовка**: отрисовывает все активные снаряды

## Система событий ([eventBus.ts](eventBus.ts))

Централизованная событийно-ориентированная коммуникация между компонентами:

- `pathManager:pathUpdated` — вызывается при изменении пути, враги пересчитывают маршруты
- `mapManager:cannonPlaced` — вызывается при подтверждённом размещении пушки
- `mapManager:tryAddCannon` — вызывается при клике пользователя для размещения пушки

## Игровой процесс

### Последовательность инициализации

1. GameEngine создаёт MapManager и загружает данные карты
2. PathManager рассчитывает начальный путь от старта к финишу
3. Запускается автоспавн
4. Враги начинают движение по пути

### Игровой цикл (каждый кадр)

1. Очистка canvas
2. Отрисовка слоёв карты
3. Отрисовка пути (жёлтые тайлы для отладки)
4. **Обновление врагов**:
   - Автоспавн нового врага, если интервал истёк
   - Движение всех врагов по их путям
   - Удаление уничтоженных / дошедших врагов
5. **Обновление пушек**:
   - Проверка врагов в радиусе
   - Выстрел (создание снарядов через ProjectileManager), если кулдаун завершён
6. **Обновление снарядов**:
   - Движение всех снарядов к целям
   - Проверка столкновений снаряд–враг
   - Нанесение урона при попадании
   - Удаление уничтоженных снарядов
7. Отрисовка пушек (с кругами радиуса)
8. Отрисовка снарядов
9. Отрисовка врагов (с полосками здоровья)

### Процесс размещения пушки

1. Игрок кликает по canvas
2. MapManager переводит клик в координаты тайла
3. Проверяется валидность тайла (не стартовый, не занятый)
4. MapManager отправляет событие `tryAddCannon`
5. PathManager проверяет размещение:
   - Временно добавляет пушку в карту коллизий
   - Пытается найти путь с новым препятствием
   - Если путь существует — подтверждает размещение
   - Если пути нет — показывает alert и отклоняет
6. При успехе отправляется событие `cannonPlaced`
7. CannonManager создаёт новую пушку в позиции
8. PathManager отправляет событие `pathUpdated`
9. Все враги пересчитывают маршруты с текущих позиций

### Боевая механика

1. Каждый кадр пушки проверяют всех живых врагов
2. Если враг в радиусе И кулдаун завершён:
   - Пушка создаёт снаряд через ProjectileManager
   - Снаряд нацелен на текущую позицию врага
   - Запускается таймер кулдауна пушки
3. ProjectileManager обновляет все активные снаряды:
   - Снаряды движутся к цели каждый кадр
   - Проверяются столкновения с врагами
4. При столкновении с врагом:
   - Снаряд наносит урон врагу
   - Снаряд уничтожается
   - Если здоровье врага достигает 0 — он помечается как уничтоженный
5. Уничтоженные враги удаляются на следующем кадре EnemyManager'ом
6. Уничтоженные снаряды удаляются ProjectileManager'ом

## Конфигурация ([game/config.ts](game/config.ts))

Все параметры игры централизованы:

- **Размер тайла**: 32 пикселя
- **Враг**: скорость 1px/кадр, 100 HP, радиус 10px
- **Пушка**: радиус 64px, скорострельность 1000мс, скорость снаряда 5px/кадр, урон 2
- **Спавн**: интервал 2000мс, 3 начальных врага
- **Полоска здоровья**: ширина 30px, высота 4px, смещение 18px над врагом

## Ключевые паттерны

- **Manager Pattern**: отдельные менеджеры для Map, Path, Enemy, Cannon, Projectile
- **Event-Driven**: слабосвязанное взаимодействие через EventBus
- **Entity-Component**: каждый враг, пушка и снаряд — независимая сущность
- **Разделение ответственности**: снаряды управляются централизованно через ProjectileManager, а не каждой пушкой отдельно
- **Реактивный поиск пути**: путь пересчитывается при изменении карты
- **Валидация перед изменением состояния**: путь должен существовать до подтверждения размещения пушки
